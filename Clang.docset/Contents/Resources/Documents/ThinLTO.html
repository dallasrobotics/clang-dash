<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ThinLTO &mdash; Clang 4 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Clang 4 documentation" href="index.html" />
    <link rel="next" title="Clang “man” pages" href="CommandGuide/index.html" />
    <link rel="prev" title="MSVC compatibility" href="MSVCCompatibility.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Clang 4 documentation</span></a></h1>
        <h2 class="heading"><span>ThinLTO</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="MSVCCompatibility.html">MSVC compatibility</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="CommandGuide/index.html">Clang &#8220;man&#8221; pages</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="thinlto">
<h1>ThinLTO<a class="headerlink" href="#thinlto" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id4">Introduction</a></li>
<li><a class="reference internal" href="#current-status" id="id5">Current Status</a><ul>
<li><a class="reference internal" href="#clang-llvm" id="id6">Clang/LLVM</a></li>
<li><a class="reference internal" href="#linkers" id="id7">Linkers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage" id="id8">Usage</a><ul>
<li><a class="reference internal" href="#basic" id="id9">Basic</a></li>
<li><a class="reference internal" href="#controlling-backend-parallelism" id="id10">Controlling Backend Parallelism</a></li>
<li><a class="reference internal" href="#incremental" id="id11">Incremental</a></li>
<li><a class="reference internal" href="#clang-bootstrap" id="id12">Clang Bootstrap</a></li>
</ul>
</li>
<li><a class="reference internal" href="#more-information" id="id13">More Information</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id4">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><em>ThinLTO</em> compilation is a new type of LTO that is both scalable and
incremental. <em>LTO</em> (Link Time Optimization) achieves better
runtime performance through whole-program analysis and cross-module
optimization. However, monolithic LTO implements this by merging all
input into a single module, which is not scalable
in time or memory, and also prevents fast incremental compiles.</p>
<p>In ThinLTO mode, as with regular LTO, clang emits LLVM bitcode after the
compile phase. The ThinLTO bitcode is augmented with a compact summary
of the module. During the link step, only the summaries are read and
merged into a combined summary index, which includes an index of function
locations for later cross-module function importing. Fast and efficient
whole-program analysis is then performed on the combined summary index.</p>
<p>However, all transformations, including function importing, occur
later when the modules are optimized in fully parallel backends.
By default, <a class="reference internal" href="#id1">linkers</a> that support ThinLTO are set up to launch
the ThinLTO backends in threads. So the usage model is not affected
as the distinction between the fast serial thin link step and the backends
is transparent to the user.</p>
<p>For more information on the ThinLTO design and current performance,
see the LLVM blog post <a class="reference external" href="http://blog.llvm.org/2016/06/thinlto-scalable-and-incremental-lto.html">ThinLTO: Scalable and Incremental LTO</a>.
While tuning is still in progress, results in the blog post show that
ThinLTO already performs well compared to LTO, in many cases matching
the performance improvement.</p>
</div>
<div class="section" id="current-status">
<h2><a class="toc-backref" href="#id5">Current Status</a><a class="headerlink" href="#current-status" title="Permalink to this headline">¶</a></h2>
<div class="section" id="clang-llvm">
<h3><a class="toc-backref" href="#id6">Clang/LLVM</a><a class="headerlink" href="#clang-llvm" title="Permalink to this headline">¶</a></h3>
<p id="compiler">The 3.9 release of clang includes ThinLTO support. However, ThinLTO
is under active development, and new features, improvements and bugfixes
are being added for the next release. For the latest ThinLTO support,
<a class="reference external" href="http://llvm.org/docs/CMake.html">build a recent version of clang and LLVM</a>.</p>
</div>
<div class="section" id="linkers">
<h3><a class="toc-backref" href="#id7">Linkers</a><a class="headerlink" href="#linkers" title="Permalink to this headline">¶</a></h3>
<p id="linker"><span id="id1"></span>ThinLTO is currently supported for the following linkers:</p>
<ul class="simple">
<li><strong>gold (via the gold-plugin)</strong>:
Similar to monolithic LTO, this requires using
a <a class="reference external" href="http://llvm.org/docs/GoldPlugin.html">gold linker configured with plugins enabled</a>.</li>
<li><strong>ld64</strong>:
Starting with <a class="reference external" href="https://developer.apple.com/xcode/">Xcode 8</a>.</li>
<li><strong>lld</strong>:
Starting with r284050 (ELF only).</li>
</ul>
</div>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id8">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="basic">
<h3><a class="toc-backref" href="#id9">Basic</a><a class="headerlink" href="#basic" title="Permalink to this headline">¶</a></h3>
<p>To utilize ThinLTO, simply add the -flto=thin option to compile and link. E.g.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">%</span> clang -flto<span class="o">=</span>thin -O2 file1.c file2.c -c
<span class="gp">%</span> clang -flto<span class="o">=</span>thin -O2 file1.o file2.o -o a.out
</pre></div>
</div>
<p>As mentioned earlier, by default the linkers will launch the ThinLTO backend
threads in parallel, passing the resulting native object files back to the
linker for the final native link.  As such, the usage model the same as
non-LTO.</p>
<p>With gold, if you see an error during the link of the form:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">/usr/bin/ld: error: /path/to/clang/bin/../lib/LLVMgold.so: could not load plugin library: /path/to/clang/bin/../lib/LLVMgold.so: cannot open shared object file: No such file or directory</span>
</pre></div>
</div>
<p>Then either gold was not configured with plugins enabled, or clang
was not built with <code class="docutils literal"><span class="pre">-DLLVM_BINUTILS_INCDIR</span></code> set properly. See
the instructions for the
<a class="reference external" href="http://llvm.org/docs/GoldPlugin.html#how-to-build-it">LLVM gold plugin</a>.</p>
</div>
<div class="section" id="controlling-backend-parallelism">
<h3><a class="toc-backref" href="#id10">Controlling Backend Parallelism</a><a class="headerlink" href="#controlling-backend-parallelism" title="Permalink to this headline">¶</a></h3>
<p id="parallelism">By default, the ThinLTO link step will launch up to
<code class="docutils literal"><span class="pre">std::thread::hardware_concurrency</span></code> number of threads in parallel.
For machines with hyper-threading, this is the total number of
virtual cores. For some applications and machine configurations this
may be too aggressive, in which case the amount of parallelism can
be reduced to <code class="docutils literal"><span class="pre">N</span></code> via:</p>
<ul class="simple">
<li>gold:
<code class="docutils literal"><span class="pre">-Wl,-plugin-opt,jobs=N</span></code></li>
<li>ld64:
<code class="docutils literal"><span class="pre">-Wl,-mllvm,-threads=N</span></code></li>
<li>lld:
<code class="docutils literal"><span class="pre">-Wl,--thinlto-jobs=N</span></code></li>
</ul>
</div>
<div class="section" id="incremental">
<h3><a class="toc-backref" href="#id11">Incremental</a><a class="headerlink" href="#incremental" title="Permalink to this headline">¶</a></h3>
<p id="id2">ThinLTO supports fast incremental builds through the use of a cache,
which currently must be enabled through a linker option.</p>
<ul class="simple">
<li>gold (as of LLVM r279883):
<code class="docutils literal"><span class="pre">-Wl,-plugin-opt,cache-dir=/path/to/cache</span></code></li>
<li>ld64 (support in clang 3.9 and Xcode 8):
<code class="docutils literal"><span class="pre">-Wl,-cache_path_lto,/path/to/cache</span></code></li>
</ul>
</div>
<div class="section" id="clang-bootstrap">
<h3><a class="toc-backref" href="#id12">Clang Bootstrap</a><a class="headerlink" href="#clang-bootstrap" title="Permalink to this headline">¶</a></h3>
<p>To bootstrap clang/LLVM with ThinLTO, follow these steps:</p>
<ol class="arabic simple">
<li>The host <a class="reference internal" href="#compiler">compiler</a> must be a version of clang that supports ThinLTO.</li>
<li>The host <a class="reference internal" href="#linker">linker</a> must support ThinLTO (and in the case of gold, must be
<a class="reference external" href="http://llvm.org/docs/GoldPlugin.html">configured with plugins enabled</a>.</li>
<li>Use the following additional <a class="reference external" href="http://llvm.org/docs/CMake.html#options-and-variables">CMake variables</a>
when configuring the bootstrap compiler build:</li>
</ol>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">-DLLVM_ENABLE_LTO=Thin</span></code></li>
<li><code class="docutils literal"><span class="pre">-DLLVM_PARALLEL_LINK_JOBS=1</span></code>
(since the ThinLTO link invokes parallel backend jobs)</li>
<li><code class="docutils literal"><span class="pre">-DCMAKE_C_COMPILER=/path/to/host/clang</span></code></li>
<li><code class="docutils literal"><span class="pre">-DCMAKE_CXX_COMPILER=/path/to/host/clang++</span></code></li>
<li><code class="docutils literal"><span class="pre">-DCMAKE_RANLIB=/path/to/host/llvm-ranlib</span></code></li>
<li><code class="docutils literal"><span class="pre">-DCMAKE_AR=/path/to/host/llvm-ar</span></code></li>
</ul>
</div></blockquote>
<ol class="arabic simple">
<li>To use additional linker arguments for controlling the backend
<a class="reference internal" href="#parallelism">parallelism</a> or enabling <a class="reference internal" href="#id2">incremental</a> builds of the bootstrap compiler,
after configuring the build, modify the resulting CMakeCache.txt file in the
build directory. Specify any additional linker options after
<code class="docutils literal"><span class="pre">CMAKE_EXE_LINKER_FLAGS:STRING=</span></code>. Note the configure may fail if
linker plugin options are instead specified directly in the previous step.</li>
</ol>
</div>
</div>
<div class="section" id="more-information">
<h2><a class="toc-backref" href="#id13">More Information</a><a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>From LLVM project blog:
<a class="reference external" href="http://blog.llvm.org/2016/06/thinlto-scalable-and-incremental-lto.html">ThinLTO: Scalable and Incremental LTO</a></li>
</ul>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="MSVCCompatibility.html">MSVC compatibility</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="CommandGuide/index.html">Clang &#8220;man&#8221; pages</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2007-2017, The Clang Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>